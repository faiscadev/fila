# Retrospective — Epic 6: Observability & Diagnostics

**Date:** 2026-02-17
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Lucas

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories | 3/3 completed (100%) |
| Scope | OTel infrastructure + core metrics, scheduler & fairness metrics, throttle & Lua diagnostic metrics |
| Test Suite | 258 tests (up from 241 in Epic 5) |
| New Tests | ~17 net new (9 metric + 6 fairness/DRR + 5 throttle/Lua - consolidations) |
| FRs Covered | FR35, FR36, FR37, FR38, FR39, FR40, FR41 |
| Metric Instruments | 14 total: 7 counters, 4 gauges, 1 histogram, plus tracing spans |
| PR Review Findings | Story 6.1 still in review status at story-file level |
| Code Review Findings | 4 total (3 in 6.1, 1 in 6.2, 0 in 6.3) — all fixed before PR |
| Technical Debt Resolved | 0 significant (deferred to new Epic 7) |
| Technical Debt Incurred | scheduler.rs grew further past 6,800 lines |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical lead
- Dana (QA Engineer) — Quality perspective
- Elena (Junior Dev) — Fresh perspective
- Lucas (Project Lead) — Decision maker

## Successes

1. **Sixth consecutive epic at 100% completion** — All 3 stories delivered. Full OTel observability layer complete. Operators can now answer "why was key X delayed?" from broker metrics alone (FR41).

2. **Retro-driven story preparation works for the third time** — Epic 5 retro sharpened Story 6.1 ACs with OTel crate compatibility check (pinned versions), in-memory test harness requirement, and `[telemetry]` config section. All three prevented real problems: no dependency conflicts, reusable `MetricTestHarness` for Stories 6.2/6.3, and clean config integration.

3. **100% retro follow-through — sixth consecutive validation** — All 6 action items from Epic 5 retro completed. Encode-or-drop is validated across 6 epics: encoded items 100% follow-through.

4. **Quality improved through the epic** — Code review findings went 3 → 1 → 0 across stories. By Story 6.3, patterns were well-established and code was clean on first pass. Patterns compound.

5. **LuaExecOutcome design improved code AND metrics** — Story 6.3's `LuaExecOutcome` enum (Success, ScriptError, CircuitBreakerBypassed) made every Lua execution path explicit. Better metrics accuracy AND clearer code. A refactoring that paid for itself immediately.

6. **MetricTestHarness is a genuine reusable asset** — `assert_counter`, `assert_gauge`, `assert_histogram`, `assert_counter_with_labels`, `assert_gauge_f64` helpers built in 6.1, extended in 6.2 and 6.3. Available for any future metric work.

## Challenges

1. **Story 6.1 scope was large** — OTel pipeline, TelemetryConfig, Metrics struct, 4 counters, 2 gauges, trace context propagation, in-memory test harness, shutdown wiring. 3 code review findings in one story (stale gauge values, unused `metrics_interval` config, dead conditional branch). OTel 0.31 API surface area was the root cause — significantly different from older tutorials.

2. **scheduler.rs continues to grow** — Now past 6,800 lines. Every epic adds more. This is the third retro noting it. Addressed by inserting Refactoring as new Epic 7.

3. **Trace context propagation partially deferred** — W3C TraceContext propagator set globally, but tonic interceptor for extracting trace context from incoming gRPC metadata not wired. Infrastructure ready but not end-to-end. Scheduled for Story 7.3.

4. **Story 6.1 status inconsistency** — Story file shows "review" while sprint-status shows "done". Fixed during this retro.

5. **Minor test count dip** — 259 (Story 6.2) → 258 (Story 6.3). Likely test consolidation, not alarming, but unexplained.

## Key Insights

1. **Foundation stories with large scope benefit from retro-driven AC sharpening** — Proven three times now (Stories 5.1, 5.4, 6.1). When the previous retro bakes preparation into ACs, the foundation story executes cleanly despite large scope.

2. **Encode-or-drop validated for the sixth time** — Encoded items: 100% follow-through across 6 consecutive epics. This is established methodology, not a guideline.

3. **Observability epic completes the safety net for scheduler refactoring** — The explicit sequencing decision ("metrics first, then refactor") from Epic 4 retro has been fulfilled. All 14 metric instruments provide runtime verification during restructuring.

4. **Refactoring epic inserted before SDKs** — The team decided to prioritize scheduler decomposition while the observability safety net is fresh and the mental model of scheduler.rs is current. SDKs don't touch internals and benefit from a cleaner codebase.

## Previous Retrospective Follow-Through

### Epic 5 Encoded Action Items

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Bake OTel crate compat check, test harness, and telemetry config into Story 6.1 ACs | ✅ Completed | Story 6.1 ACs #10-#13; pinned versions in dev notes |
| 2 | Update encode-or-drop validation count to 5 epics | ✅ Completed | MEMORY.md updated |
| 3 | Record Epic 5 lessons and Epic 6 preparation notes | ✅ Completed | MEMORY.md sections present |
| 4 | Record Story 5.3 redrive design decision (pending only) | ✅ Completed | In epics.md and MEMORY.md |
| 5 | Update scheduler.rs growth note with Epic 5 additions | ✅ Completed | MEMORY.md "Codebase Health" section |
| 6 | Sprint-status: epic-5-retrospective → done | ✅ Completed | sprint-status.yaml confirms |

**Encoded items: 6/6 completed (100%)**

**Pattern confirmed:** Encoded items 100%, sixth consecutive epic of data.

## Design Decisions

- **Imperative Gauge over ObservableGauge** (Story 6.1): Used simpler `Gauge` API instead of `ObservableGauge` callbacks since scheduler is single-threaded. Simpler code, no Arc/AtomicU64 needed.
- **LuaExecOutcome enum** (Story 6.3): Refactored `run_on_enqueue`/`run_on_failure` return types from `Option<T>` to `Option<(T, LuaExecOutcome)>` to surface execution path for metrics. Made instrumentation correct by design.
- **`start_new_round` returns bool** (Story 6.2): Changed from `()` to `bool` to prevent inflated DRR rounds counter when round was still active.
- **Refactoring before SDKs** (Retro decision): Inserted Epic 7 (Scheduler Refactoring) before Client SDKs. Timing is optimal: observability safety net in place, mental model fresh, e2e tests benefit SDK work.

## Significant Decision: Epic Renumbering

The team decided to insert the Scheduler Refactoring epic before Client SDKs:

| New # | Epic | Was |
|-------|------|-----|
| Epic 7 | Scheduler Refactoring | Future (unplanned) |
| Epic 8 | Client SDKs | Epic 7 |
| Epic 9 | Distribution & Documentation | Epic 8 |

**Rationale:**
- Observability safety net (Epic 6) now complete — the explicit prerequisite
- Mental model of scheduler.rs is freshest now
- Blackbox e2e tests serve double duty: refactoring safety net AND SDK regression coverage
- SDKs don't touch scheduler internals — refactoring timing doesn't affect them
- A 6,800+ line file is a maintenance liability for all future work

## Action Items — Encoded Changes

Every action item has been encoded into a file that agents read during execution.

### Changes Made During This Retro

| # | Action | File Changed | Type |
|---|--------|-------------|------|
| 1 | Renumber epics: Refactoring → 7, SDKs → 8, Docs → 9. Define Epic 7 with 3 stories and sharpened ACs | `_bmad-output/planning-artifacts/epics.md` | Epic definition |
| 2 | Update sprint-status: renumber all entries, add Epic 7 refactoring stories | `_bmad-output/implementation-artifacts/sprint-status.yaml` | Tracking update |
| 3 | Fix Story 6.1 status from "review" → "done" | `_bmad-output/implementation-artifacts/6-1-otel-infrastructure-core-metrics.md` | Status fix |
| 4 | Record Epic 6 results, refactoring decision, updated numbering | `memory/MEMORY.md` | Memory update |
| 5 | Update encode-or-drop validation count to 6 epics | `memory/MEMORY.md` | Memory update |
| 6 | Sprint-status: epic-6-retrospective → done | `_bmad-output/implementation-artifacts/sprint-status.yaml` | Tracking update |

### Explicitly Dropped

| # | Proposed Action | Reason for Drop |
|---|----------------|-----------------|
| 1 | Investigate test count dip (259 → 258) | Minor, likely test consolidation. Not worth a dedicated action item. |

## Readiness Assessment

| Area | Status | Details |
|------|--------|---------|
| Testing & Quality | ✅ Ready | 258 tests, clippy clean, fmt clean. 20 metric-specific tests. |
| Deployment | ✅ N/A | Pre-release project, no deployment needed. |
| Stakeholder Acceptance | ✅ Accepted | Lucas reviewed and approved all stories. |
| Technical Health | ⚠️ Known concern | scheduler.rs past 6,800 lines. Addressed by new Epic 7. |
| Unresolved Blockers | ✅ None | Trace context propagation deferred to Story 7.3. |

## Closure

**Key Takeaways:**

1. Retro-driven story preparation works for the third time — repeat for Epic 7 (Story 7.1 ACs already sharpened)
2. Encode-or-drop validated for the sixth consecutive epic — 100% follow-through
3. Quality improved through the epic (3 → 1 → 0 findings) — patterns compound
4. Refactoring epic inserted at the right time — observability safety net in place

**Changes Executed:**
- Epic 7 (Scheduler Refactoring) defined with 3 stories and sharpened ACs in epics.md
- Epic numbering updated: 7→Refactoring, 8→SDKs, 9→Docs
- Sprint-status updated with new epic structure and retrospective marked done
- Story 6.1 status fixed (review → done)
- MEMORY.md updated (Epic 6 results, Epic 7 prep, encode-or-drop count, codebase health)

**Next Steps:**

1. Begin Epic 7 story creation when ready (stories already defined in epics.md)
2. Story 7.1 (blackbox e2e tests) is the foundation — must complete before decomposition
3. No prep sprint needed — Story 7.1 ACs are sharpened with 11 specific e2e test scenarios
4. Epic 8 (Client SDKs) follows after refactoring is complete

**Epic 6 delivered the complete observability layer.** Fila now exports 14 OTel metric instruments covering message lifecycle, DRR fairness, throttle decisions, and Lua execution. Operators can diagnose "why was key X delayed?" from metrics alone. The retro's most significant outcome: inserting the Scheduler Refactoring epic (new Epic 7) before Client SDKs, with sharpened Story 7.1 ACs for the blackbox e2e test suite.
