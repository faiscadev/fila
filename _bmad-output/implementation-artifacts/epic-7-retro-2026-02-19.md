# Retrospective — Epic 7: Rust Client SDK

**Date:** 2026-02-19
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Lucas

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories | 1/1 completed (100%) |
| Scope | Idiomatic Rust client SDK (`fila-sdk` crate) wrapping tonic gRPC |
| Test Suite | 267 tests (up from 258 in Epic 6) |
| New Tests | 9 net new (3 SDK integration tests + 6 from restructuring/refactor) |
| FRs Covered | FR46, FR48 (partial — Rust only) |
| PR Review Findings | 2 Cubic findings on PR #30, both addressed |
| Code Review Findings | 0 in-process (Cubic caught 2 post-PR) |
| Technical Debt Resolved | God-enum `ClientError` replaced with per-operation error types |
| Technical Debt Incurred | None |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical lead
- Dana (QA Engineer) — Quality perspective
- Elena (Junior Dev) — Fresh perspective
- Lucas (Project Lead) — Decision maker

## Successes

1. **Seventh consecutive epic at 100% completion** — The single-story epic delivered a clean, idiomatic Rust SDK. All 9 ACs met. The SDK is `Clone + Send + Sync`, uses async/await, and follows Rust conventions throughout.

2. **Lucas's code review drove a genuine design improvement** — PR #30 initially shipped with a "god-enum" `ClientError` where every method could return every variant. Lucas flagged that `lease`'s inner stream Result could never produce `QueueNotFound`, revealing the design flaw. This led to the `refactor: replace god-enum ClientError with per-operation error types` commit, producing `ConnectError`, `EnqueueError`, `LeaseError`, `AckError`, `NackError` — each containing only the variants their operation can actually produce. This mirrors the server-side per-command error pattern already in CLAUDE.md.

3. **Integration test infrastructure is reusable** — `TestServer` helper (spawns `fila-server` on random port, temp dir, polls for readiness, kills on Drop) is immediately available for Epic 8's blackbox e2e test suite. The pattern is proven across 3 integration tests.

4. **Crate naming settled** — Originally `fila-client`, renamed to `fila-sdk` during Cubic review round. This naming is clearer and aligns with industry convention (SDK vs raw client).

5. **Encode-or-drop validated for the seventh consecutive epic** — All 6 action items from Epic 6 retro were completed. 100% follow-through continues.

## Challenges

1. **Dev agent missed what Lucas caught in review** — The god-enum `ClientError` shipped in the initial PR. While not a bug, it was a design weakness that contradicts the project's own CLAUDE.md error-handling rules. The dev agent didn't self-apply the "per-command error types" pattern to client-side code. Lucas's review flagged the issue, leading to a better design.

2. **TestServer startup race** — Cubic correctly flagged that the startup poll didn't assert the server actually became reachable. If the timeout elapsed, tests would proceed with an unusable client. Fixed by tracking connection success and asserting after the loop.

3. **filter_map silently dropped None messages** — Cubic flagged that `None` message fields in lease responses were silently dropped via `filter_map`. This is actually intentional (tonic sends keepalive frames), but the rationale wasn't documented. The code was left as-is since filtering keepalives is correct behavior, but a comment was warranted.

## Key Insights

1. **Per-operation error types apply to SDKs too, not just server internals** — The CLAUDE.md "Per-Command Error Types" rule was written for server-side operations. Lucas's review proved the same principle applies to client SDKs: callers of `ack()` shouldn't need to handle `QueueNotFound` if the operation can only produce `MessageNotFound`. This is now a validated cross-cutting pattern.

2. **Human review catches what automated review doesn't (and vice versa)** — Cubic caught the TestServer startup race and the silent filter_map. Lucas caught the god-enum design flaw. Different review perspectives surface different classes of issues — both are valuable.

3. **SDK-first approach validated** — The restructuring decision (pull Rust SDK before e2e tests) is now validated. The SDK's `TestServer` helper and integration tests provide the exact infrastructure Epic 8 needs. Writing e2e tests without an SDK would have meant duplicating all the gRPC boilerplate.

## Previous Retrospective Follow-Through

### Epic 6 Encoded Action Items

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Renumber epics: Refactoring → 7, SDKs → 8, Docs → 9 | ✅ Completed (then further restructured) | epics.md updated; then Sprint Change restructured to current 7-10 numbering |
| 2 | Update sprint-status with new epic structure | ✅ Completed | sprint-status.yaml reflects current structure |
| 3 | Fix Story 6.1 status from "review" → "done" | ✅ Completed | Story file updated |
| 4 | Record Epic 6 results in MEMORY.md | ✅ Completed | MEMORY.md sections present |
| 5 | Update encode-or-drop count to 6 epics | ✅ Completed | MEMORY.md updated |
| 6 | Sprint-status: epic-6-retrospective → done | ✅ Completed | sprint-status.yaml confirms |

**Encoded items: 6/6 completed (100%)**

**Note:** Action item #1 was completed as specified, then further evolved by the Sprint Change Proposal (2026-02-17) which restructured: Epic 7 = Rust SDK, Epic 8 = E2E + Refactoring, Epic 9 = SDKs, Epic 10 = Docs. This was a healthy iteration on a retro outcome.

## Design Decisions

- **Per-operation error types** (Lucas's review): Replaced `ClientError` god-enum with `ConnectError`, `EnqueueError`, `LeaseError`, `AckError`, `NackError`. Each operation's return type only includes variants it can actually produce. Mirrors server-side pattern.
- **Crate name: fila-sdk** (not fila-client): Industry convention — "SDK" signals a higher-level abstraction than a raw "client". Also avoids confusion with the CLI (`fila`).
- **Thin wrapper, no retry/reconnection logic**: SDK stays thin. Consumers handle retries. This keeps the SDK predictable and composable.
- **filter_map for None lease messages**: Correct behavior — tonic sends keepalive frames with no message. Silent filtering is intentional but should be documented.

## Next Epic Preview — Epic 8: E2E Tests & Scheduler Refactoring

**3 stories planned:**

1. **Story 8.1: Blackbox E2E Test Suite** — True blackbox tests using `fila-sdk` (producer/consumer) and `fila` CLI (admin). 11 test scenarios covering all major flows. `TestServer` helper from Epic 7 is the starting point.

2. **Story 8.2: Scheduler Decomposition** — Split `scheduler.rs` (6,800+ lines) into submodules under `broker/scheduler/`. Target: no module over ~500 lines. E2e suite from 8.1 provides behavioral safety net.

3. **Story 8.3: Cleanup & Deferred Items** — Wire tonic interceptor for W3C trace context extraction. Clean up dead code found during decomposition.

**Dependencies on Epic 7:**
- `fila-sdk` crate is the client for all e2e producer/consumer operations
- `TestServer` helper pattern is reusable for e2e test harness
- Per-operation error types make test assertions more precise

**No blockers identified.** Epic 8 can start immediately.

## Action Items — Encoded Changes

Every action item has been encoded into a file that agents read during execution.

### Changes Made During This Retro

| # | Action | File Changed | Type |
|---|--------|-------------|------|
| 1 | Record Epic 7 results and SDK-first validation | `memory/MEMORY.md` | Memory update |
| 2 | Update encode-or-drop validation count to 7 epics | `memory/MEMORY.md` | Memory update |
| 3 | Sprint-status: epic-7-retrospective → done | `sprint-status.yaml` | Tracking update |

### Explicitly Dropped

| # | Proposed Action | Reason for Drop |
|---|----------------|-----------------|
| 1 | Add "per-operation error types apply to SDKs" rule to CLAUDE.md | Already covered by existing "Per-Command Error Types" section — the pattern is generic enough. Adding a client-specific note would be redundant. The dev agent learned it through this experience. |
| 2 | Document filter_map rationale for keepalive frames | Low-value — the code pattern is self-evident with the existing code comment. Not worth a CLAUDE.md entry. |

## Readiness Assessment

| Area | Status | Details |
|------|--------|---------|
| Testing & Quality | ✅ Ready | 267 tests, clippy clean, fmt clean. 3 SDK integration tests. |
| Deployment | ✅ N/A | Pre-release project, no deployment needed. |
| Stakeholder Acceptance | ✅ Accepted | Lucas reviewed and approved. |
| Technical Health | ⚠️ Known concern | scheduler.rs still 6,800+ lines. Addressed by Epic 8 Story 8.2. |
| Unresolved Blockers | ✅ None | Trace context interceptor deferred to Story 8.3. |

## Closure

**Key Takeaways:**

1. Per-operation error types apply to SDKs too — Lucas's review drove this improvement
2. Encode-or-drop validated for the seventh consecutive epic — 100% follow-through
3. SDK-first restructuring validated — `TestServer` helper and integration patterns ready for Epic 8
4. Small epics can still surface design improvements — code size doesn't correlate with lesson density

**Changes Executed:**
- MEMORY.md updated (Epic 7 results, encode-or-drop count)
- Sprint-status updated: epic-7-retrospective → done

**Next Steps:**

1. Begin Epic 8 story creation when ready (stories already defined in epics.md)
2. Story 8.1 (Blackbox E2E Test Suite) is the foundation — must complete before decomposition
3. No prep sprint needed — SDK and TestServer infrastructure already proven
4. Story 8.1 ACs already include 11 specific e2e test scenarios

**Epic 7 delivered the Rust client SDK.** `fila-sdk` provides idiomatic async Rust APIs for enqueue, streaming lease, ack, and nack. Per-operation error types make the API precise and safe. The SDK serves double duty: application integration AND the test client for Epic 8's blackbox e2e suite.
