# Retrospective — Epic 3: Lua Rules Engine & Dead-Letter Handling

**Date:** 2026-02-12
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Lucas

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories | 4/4 completed (100%) |
| Scope | Lua sandbox & on_enqueue hook, safety limits/circuit breaker, on_failure hook & retry decisions, DLQ auto-creation |
| Test Suite | 137+ tests passing (up from 92 in Epic 2) |
| FRs Covered | FR6, FR18-FR25, FR32 |
| Architecture Deviations | 0 |
| Cubic Post-PR Bugs Found | 4 (all fixed) |
| Technical Debt Carried Forward | 2 (O(n²) delivery scan, sprint-status tracking) |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical lead
- Dana (QA Engineer) — Quality perspective
- Elena (Junior Dev) — Fresh perspective
- Lucas (Project Lead) — Decision maker

## Successes

1. **Embedded a full scripting engine with safety guarantees in 4 stories** — The Lua integration turns Fila from a scheduling engine into a configurable product. `on_enqueue` assigns fairness keys/weights/throttle keys, `on_failure` controls retry vs DLQ routing, all sandboxed with timeouts, memory limits, and circuit breaker.

2. **mlua spike investment paid off massively** — The spike (Epic 2 critical path item, driven by Lucas) pre-validated all key capabilities: bytecode precompilation, instruction count hooks, memory limits, fila.get() bridge. Story 3.1 was execution, not exploration.

3. **Pattern reuse delivered compound returns** — Story 3.1 established the Lua integration pattern. Stories 3.2-3.4 built cleanly on it. Story 3.4 (DLQ) was only 3 tasks because all infrastructure was in place. This validates the Epic 2 retro insight about investing in clean patterns in early stories.

4. **Test suite grew 49%** — From 92 tests (end of Epic 2) to 137+ tests. Story 3.2 alone added 11 unit tests for the circuit breaker plus 4 integration tests. Strong safety coverage.

5. **Cubic automated review caught 4 real bugs** — Safety/correctness issues that would have shipped: first-writer-wins config, fail-open safety, DLQ-of-DLQ, aggressive cascade-delete. All fixed post-PR.

## Challenges

1. **Dev agent did not check Cubic findings — 2 out of 4 stories (3.3, 3.4)** — Both stories have the same note: "cubic's automated review flagged the issue on the PR, but the dev agent did not check cubic's review findings before marking the story complete." Systematic process gap.

2. **Same bug pattern recurred across stories** — The fail-open safety hooks bug (scripts running without limits when per-queue config was missing) was fixed for `run_on_enqueue` in PR #17, then reintroduced for `run_on_failure` in Story 3.3. Root cause: Cubic findings on 3.3 weren't addressed before starting 3.4, so the fix wasn't in place when the next story was built.

3. **Sprint-status tracking broken for third consecutive epic** — None of the 4 stories had correct status. Story 3.2 showed "in-progress" despite being complete. Stories 3.3 and 3.4 showed "backlog" despite being fully implemented and reviewed.

4. **Story files not updated after implementation (3.3, 3.4)** — Both still show "ready-for-dev" status with unchecked task boxes despite having "Post-PR Review Fixes" sections. The story completion workflow didn't update these artifacts.

5. **Retro action items have ~30% organic follow-through** — Of Epic 2's commitments, only items Lucas personally drove got done. Sprint-status fix, O(n²) scan optimization, and test infrastructure investment — all assigned but not completed.

## Key Insights

1. **Retro commitments only stick when encoded into files agents read.** The mlua spike happened because Lucas explicitly drove it. The O(n²) fix didn't happen because it was just a line in a retro doc. "Team agreements" in markdown have ~30% follow-through. The only reliable enforcement is structural.

2. **Cubic is a critical safety net — but only if someone checks its output.** Cubic found real correctness bugs in every story it reviewed. The problem wasn't Cubic's quality — it was the dev agent's workflow not including a "check Cubic" step.

3. **Bug propagation across sequential PRs** — When Cubic findings aren't addressed before starting the next story, bugs propagate. Story 3.3's fail-open pattern was replicated in 3.4 because the fix wasn't applied before 3.4 was built.

4. **Pattern establishment continues to pay compound returns** — Third epic confirming this. The investment in Story 3.1's clean Lua architecture made 3.2-3.4 fast and clean.

## Previous Retrospective Follow-Through

### Epic 2 Action Items Assessment

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Fix sprint-status update reliability | ❌ Not Addressed | All 4 stories + epic have wrong status |
| 2 | Test infrastructure for concurrent scheduler | ⏳ Partial | Story 3.1 refactored 5 threaded tests but no shared test helpers built |
| 3 | O(n²) delivery scan optimization (High priority) | ❌ Not Addressed | No mention in any Story 3.x dev notes |

### Epic 2 Team Agreements Assessment

| Agreement | Status |
|-----------|--------|
| Test every AC with corresponding test | ✅ Followed |
| Write safety property tests before implementing | ⏳ Unclear |
| Sprint-status updated as final step of every story | ❌ Not followed (0/4 stories) |
| mlua spike completed before Epic 3 | ✅ Done (Lucas drove it) |

**Summary:** ~30% organic follow-through. Items succeeded only when Lucas personally ensured they happened.

**Root cause:** Retro action items lived in a markdown file that no workflow referenced. No enforcement mechanism existed.

## Next Epic Preview

**Epic 4: Throttling & Rate Limiting** — 3 stories

| Story | Description | Dependency on Epic 3 |
|-------|-------------|----------------------|
| 4.1 | Token Bucket Implementation | Standalone data structure |
| 4.2 | Throttle-Aware Scheduling | Lua-assigned throttle_keys, DRR delivery path (+ O(n²) scan fix) |
| 4.3 | Runtime Throttle Rate Management | fila.get() bridge, state CF |

**Dependencies on Epic 3 are solid.** Lua integration, safety layer, and fila.get() bridge all working with full test coverage.

**Story 4.2 updated** to include O(n²) scan optimization as acceptance criteria — ensuring this tech debt is addressed when the delivery path is modified for throttle-aware scheduling.

## Action Items — Encoded Changes

Every action item from this retro has been encoded into a file that agents read during execution. No "team agreements" — only structural enforcement.

### Changes Made During This Retro

| # | Action | File Changed | Type |
|---|--------|-------------|------|
| 1 | Cubic review check instructions — full description of how Cubic works, required process for checking findings | `CLAUDE.md` | Project instruction (always loaded) |
| 2 | Cubic lesson + sprint-status importance | `.claude/projects/.../memory/MEMORY.md` | Agent memory (persistent) |
| 3 | Sprint-status fixed — all Epic 3 entries updated to done | `sprint-status.yaml` | Immediate fix |
| 4 | O(n²) scan optimization baked into Story 4.2 ACs | `epics.md` | Story definition (read at story creation) |

### Workflow Changes Needed (Future Tasks)

| # | Action | Target File | Notes |
|---|--------|------------|-------|
| 1 | Add Cubic check gate step to dev-story workflow | `_bmad/bmm/workflows/4-implementation/dev-story/instructions.xml` | After Step 9 (mark for review), add step: wait for Cubic CI, check output, address findings |
| 2 | Ensure sprint-status updates are enforced in execute-epic | `_bmad/bmm/workflows/4-implementation/execute-epic/steps-c/` | Verify story completion updates sprint-status to "done" |
| 3 | Add "encode or drop" enforcement to retro workflow | `_bmad/bmm/workflows/4-implementation/retrospective/instructions.md` | New step: each action item must map to a file change or be dropped |

## Significant Discovery Assessment

No significant discoveries from Epic 3 that fundamentally change the plan for Epic 4. The Lua integration is clean, the scheduler architecture holds, and all Epic 3 work that Epic 4 depends on is solid.

**One concern carried forward:** The O(n²) delivery scan will interact with per-message throttle checking in Epic 4. This is now addressed by baking the optimization into Story 4.2's acceptance criteria.

**Epic update required:** NO — Epic 4 plan is sound (with the Story 4.2 enhancement).

## Readiness Assessment

| Area | Status | Details |
|------|--------|---------|
| Testing & Quality | ✅ Ready | 137+ automated tests. Cubic caught and fixed 4 post-PR bugs. No manual e2e (future). |
| Codebase Health | ✅ Stable | Lua integration clean, safety fail-closed after fixes, DLQ works. |
| Architecture Doc | ✅ Current | No deviations requiring updates. |
| Sprint-Status | ✅ Fixed | Corrected during this retrospective. |
| Epic 3 Foundations | ✅ Solid | Lua hooks, safety layer, fila.get() bridge — all working with full coverage. |
| Unresolved Blockers | ✅ Addressed | O(n²) scan baked into Story 4.2 ACs. |

**Overall:** Epic 3 is fully complete. No blocking prep tasks before Epic 4. The O(n²) scan optimization is embedded in Story 4.2 and cannot be skipped.

## Closure

**Key Takeaways:**

1. Retro action items must be encoded into files agents read — or they won't happen
2. Cubic is a critical safety net, but checking its output must be a workflow gate, not optional
3. Pattern establishment continues to pay compound returns — invest in clean architecture in early stories
4. Bug propagation across sequential PRs is prevented by addressing review findings before starting the next story

**Changes Executed:**
- CLAUDE.md updated with Cubic review instructions (always loaded by all agents)
- Memory file updated with workflow lessons and Cubic details
- Sprint-status.yaml fixed (all Epic 3 entries → done)
- Story 4.2 in epics.md updated with O(n²) scan optimization ACs
- 3 workflow changes identified for future implementation

**Next Steps:**

1. Begin Epic 4 story creation when ready
2. Story 4.2 now includes the O(n²) scan fix — it's in the ACs, not a side agreement
3. Implement the 3 identified workflow changes (dev-story Cubic gate, execute-epic sprint-status enforcement, retro encode-or-drop rule)
4. Every agent session will now see Cubic instructions via CLAUDE.md

**Epic 3 delivered the user-facing policy layer that makes Fila's scheduling primitive configurable.** Lua scripts assign fairness keys, control retry behavior, and route to dead-letter queues — all sandboxed with safety guarantees. The retro surfaced a critical process gap (Cubic findings not checked) and addressed it structurally rather than aspirationally.
