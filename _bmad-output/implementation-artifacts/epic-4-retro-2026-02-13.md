# Retrospective — Epic 4: Throttling & Rate Limiting

**Date:** 2026-02-13
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Lucas

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories | 3/3 completed (100%) |
| Scope | Token bucket implementation, throttle-aware DRR scheduling, runtime throttle rate management |
| Test Suite | ~200+ tests (up from 137+ in Epic 3) |
| FRs Covered | FR13, FR14, FR15, FR16, FR17 (plus FR26-FR29 partially via SetConfig/GetConfig) |
| Architecture Deviations | 1 minor (AC #5 changed: "no deficit consumed" → "consume deficit" to fix infinite loop) |
| Code Review Bugs Caught | 8+ across Stories 4.2 and 4.3 |
| Technical Debt Resolved | 1 (O(n²) delivery scan → pending index) |
| Technical Debt Incurred | 0 significant |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical lead
- Dana (QA Engineer) — Quality perspective
- Elena (Junior Dev) — Fresh perspective
- Lucas (Project Lead) — Decision maker

## Successes

1. **100% story completion, fourth consecutive epic** — All 3 stories delivered. Per-key token bucket rate limiting, multi-key hierarchical throttling, zero wasted work scheduling, and runtime rate management — all working.

2. **O(n²) technical debt resolved** — The pending index in Story 4.2 replaced the delivery scan that's been technical debt since Epic 2, deferred through Epic 3. The 10k fairness test was un-ignored and runs in ~19s. This debt was killed because it was baked into Story 4.2's acceptance criteria in epics.md — structural enforcement works.

3. **Code review caught 8+ real bugs** — Story 4.2: token waste on failed delivery (peek_keys/consume_keys split), O(n) deficit consumption on throttle skip (drain_deficit), memory leak from uncleaned pending deques, leased_msg_keys not cleaned on queue delete. Story 4.3: validate-before-persist, reject NaN/Inf values, proper RocksDB iterator usage, reject empty keys, size limits. The review process works.

4. **Previous retro encoded items: 100% follow-through** — All 4 items encoded into files agents read (CLAUDE.md, MEMORY.md, epics.md, sprint-status.yaml) were completed. The "encode or drop" principle holds for the fourth consecutive epic.

5. **Test suite grew to ~200+** — Solid coverage across token bucket, throttle integration, config management, recovery.

6. **Unified SetConfig/GetConfig design** — Story 4.3's approach is cleaner and more extensible than separate throttle commands. Reusable for Epic 5's configuration needs.

## Challenges

1. **Execute-epic opened all PRs against main** — The execute-epic workflow's Step 5 had an ambiguous instruction: `Base: The appropriate base branch (main or dependent story's branch)`. No decision tree, no logic. The agent defaulted to `main`, breaking the stacked PR chain (should have been 4.1→main, 4.2→4.1, 4.3→4.2). PR #21 had to be re-targeted. A commit to main had to be reverted.

2. **Cascade rebase corrupted sprint-status** — Recurring in all 4 epics. After merging the 1st PR and rebasing the 2nd, sprint-status.yaml conflicts are resolved incorrectly. Both sides are partially correct, and manual resolution picks the wrong values.

3. **No structured review workflow** — Post-PR review/merge/rebase was done via ad-hoc messages in the same session that ran execute-epic. The agent was no longer following workflow gates, so rules were not enforced. This is how the PR targeting error and Cubic review miss happened — the session was disrupted and the agent never returned to the CI/Cubic loop.

4. **Story files not updated to "done"** — All 3 stories still showed "Status: review" despite being complete. No workflow step enforces updating story file status after merge.

5. **Deferred workflow changes: 33% follow-through** — Only 1 of 3 deferred workflow changes from Epic 3 retro was completed (encode-or-drop rule in retro workflow). Cubic gate in dev-story and sprint-status enforcement in execute-epic were not addressed.

## Key Insights

1. **One ambiguous workflow line caused cascading incidents** — Step 5's vague PR targeting → wrong Cubic scope → disrupted reviews → wrong rebase → wrong tracking. Precision in workflow instructions matters. The branching logic existed in Step 2 but was not replicated for PR creation in Step 5.

2. **Agent-assisted reviews need structural enforcement** — Ad-hoc messages in the same session don't enforce rules. The agent was responding to correction messages, not following workflow gates. A dedicated review workflow with hard gates is needed.

3. **"Encode or drop" validated for the fourth time** — Encoded items: 100% follow-through. Deferred items: 33%. This is now a law, not a guideline.

4. **Refactoring needs e2e tests first** — scheduler.rs at 5,497 lines (half the codebase) is a growing concern, but splitting without blackbox test coverage risks regressions. Dedicated epic needed: e2e tests → scheduler split → cleanup.

## Previous Retrospective Follow-Through

### Epic 3 Encoded Action Items (Immediate)

| # | Action Item | Status | Evidence |
|---|-------------|--------|----------|
| 1 | Cubic review check instructions in CLAUDE.md | ✅ Completed | Full Cubic section present in CLAUDE.md |
| 2 | Cubic lesson + sprint-status importance in MEMORY.md | ✅ Completed | MEMORY.md has the lessons documented |
| 3 | Sprint-status fixed (Epic 3 entries) | ✅ Completed | All entries correct in sprint-status.yaml |
| 4 | O(n²) scan optimization baked into Story 4.2 ACs | ✅ Completed | Story 4.2 implemented pending index, 10k test un-ignored |

**Immediate items: 4/4 completed (100%)**

### Epic 3 Deferred Workflow Changes

| # | Change | Status | Evidence |
|---|--------|--------|----------|
| 1 | Add Cubic check gate to dev-story workflow | ❌ Not Addressed | Dev-story has reminder in Step 10, not enforced gate |
| 2 | Sprint-status updates enforced in execute-epic | ❌ Not Addressed | Story files still show "review" status |
| 3 | Add "encode or drop" to retro workflow | ✅ Completed | Retro workflow has ENCODE OR DROP RULE section |

**Deferred items: 1/3 completed (33%)**

**Pattern confirmed:** Encoded items 100%, deferred items 33%. Fourth epic of data.

## Significant Discovery: Story 5.1 Overlap

Story 4.3 (Runtime Throttle Rate Management) implemented `SetConfig`/`GetConfig` RPCs with persistence, Lua `fila.get()` integration, throttle-prefix side effects, and crash recovery. This substantially overlaps with Epic 5, Story 5.1 (Runtime Configuration API).

**Resolution:** Story 5.1 redefined in epics.md to cover only remaining scope: `ListConfig` RPC with prefix filtering, and end-to-end integration test for non-throttle config keys with Lua. Original ACs removed to prevent execute-epic re-implementing existing code.

## Action Items — Encoded Changes

Every action item has been encoded into a file that agents read during execution.

### Changes Made During This Retro

| # | Action | File Changed | Type |
|---|--------|-------------|------|
| 1 | Fix Step 5 PR base branch logic — explicit decision tree | `_bmad/bmm/workflows/4-implementation/execute-epic/steps-c/step-05-pr-ci.md` | Workflow fix |
| 2 | Redefine Story 5.1 ACs — remove 4.3 overlap, scope to ListConfig + Lua e2e test | `_bmad-output/planning-artifacts/epics.md` | Story definition |
| 3 | Sharpen Story 5.4 CLI UX ACs — error message translation, output formatting, help text | `_bmad-output/planning-artifacts/epics.md` | Story definition |
| 4 | Fix Epic 4 story file statuses → "done" | `4-{1,2,3}-*.md` | Immediate fix |
| 5 | Note refactoring epic need (e2e tests → scheduler split → cleanup) | `_bmad-output/planning-artifacts/epics.md` | Planning note |
| 6 | Sprint-status: epic-4-retrospective → done, Story 5.1 key updated | `sprint-status.yaml` | Tracking fix |

### Pre-Epic Tasks (Must Complete Before Epic 5)

| # | Action | Target | Notes |
|---|--------|--------|-------|
| 1 | Create epic-review workflow | `_bmad/bmm/workflows/4-implementation/epic-review/` (new) | Human-in-the-loop PR review/merge/rebase cycle. Design: per-PR loop (present PR → Lucas reviews → address findings/merge → rebase next → repeat). Includes Cubic gates, sprint-status updates, story file updates, cascade rebase procedure. |

## Readiness Assessment

| Area | Status | Details |
|------|--------|---------|
| Testing & Quality | ✅ Ready | ~200+ automated tests. Code review caught 8+ bugs. No manual e2e (future epic). |
| Deployment | ✅ N/A | Pre-release project, no deployment needed. |
| Stakeholder Acceptance | ✅ Accepted | Lucas reviewed all PRs. |
| Technical Health | ⚠️ Growing concern | scheduler.rs at 5,497 lines. Needs dedicated refactoring epic with e2e tests first. |
| Unresolved Blockers | ✅ None | No blocking issues for Epic 5. |

## Closure

**Key Takeaways:**

1. One ambiguous workflow line caused cascading incidents — precision in workflow instructions matters
2. Agent-assisted reviews need structural enforcement — a dedicated review workflow is the fix
3. "Encode or drop" validated for the fourth time — encoded items 100%, deferred items 33%
4. Refactoring needs e2e tests first — scheduler.rs at 5.5k lines, but splitting without behavioral tests is risky

**Changes Executed:**
- Step 5 PR base branch logic fixed with explicit decision tree
- Story 5.1 ACs redefined to remove 4.3 overlap
- Story 5.4 ACs sharpened with CLI UX specifics
- Epic 4 story files updated to "done"
- Refactoring epic need noted in epics.md
- Sprint-status updated (retrospective → done, Story 5.1 key updated)

**Pre-Epic Task:**
- Create epic-review workflow (human-in-the-loop PR review/merge/rebase cycle)

**Next Steps:**

1. Create the epic-review workflow before starting Epic 5
2. Begin Epic 5 story creation when ready
3. Story 5.1 is now scoped to ListConfig + Lua e2e test (not a re-implementation of SetConfig/GetConfig)
4. Story 5.4 has sharper CLI UX requirements

**Epic 4 delivered the final core scheduling primitive.** Fila now has fairness (DRR), Lua-driven routing (on_enqueue/on_failure hooks), and rate limiting (per-key token bucket with hierarchical throttling). The retro surfaced a critical workflow gap (no structured review process) and addressed it by committing to a new epic-review workflow.
