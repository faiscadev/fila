# Retrospective — Epic 1: Foundation & End-to-End Messaging

**Date:** 2026-02-11
**Facilitator:** Bob (Scrum Master)
**Project Lead:** Lucas

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories | 9/9 completed (100%) |
| Scope | Cargo workspace, protobuf definitions, CI/CD, core domain types, storage layer, broker core, gRPC server, queue management, message enqueue, consumer lease, message ack, crash recovery |
| Test Suite | 59 tests, all passing |
| Architecture Deviations | 1 (crossbeam -> tokio::sync::mpsc for consumer channels) |
| Technical Debt Items | 3 (message scan in delivery, message key lookup scan, error mapping duplication) |

## Team Participants

- Bob (Scrum Master) — Facilitator
- Alice (Product Owner) — Business perspective
- Charlie (Senior Dev) — Technical lead
- Dana (QA Engineer) — Quality perspective
- Elena (Junior Dev) — Fresh perspective
- Lucas (Project Lead) — Decision maker

## Successes

1. **Complete end-to-end message lifecycle** — Enqueue, Lease, Ack all working with crash recovery and zero message loss
2. **tonic 0.14 discovery (Story 1.1)** — Early build failures led to foundational knowledge about the new `tonic-prost-build` pipeline that carried the entire epic
3. **Pragmatic architecture deviation (Story 1.7)** — Switching from crossbeam to `tokio::sync::mpsc` for consumer channels simplified the gRPC streaming bridge
4. **Strong test coverage** — 59 tests covering happy paths, edge cases, and 4 crash recovery scenarios
5. **Detailed story specifications** — Dev notes with dependency versions, key encoding designs, and code patterns gave implementation clear direction

## Challenges

1. **Story file tracking broken in 6/9 stories** — Stories 1.3-1.5 have status `ready-for-dev` with empty Dev Agent Records and unchecked tasks despite being complete. Stories 1.6-1.8 show `in-progress` instead of `done`. Institutional knowledge lost for half the epic.
2. **Horizontal story slicing** — Stories created infrastructure layers (proto definitions, storage traits, stub crates) before anything needed them. Violated YAGNI — built for the architecture doc rather than for immediate user value.
3. **Architecture doc drift** — Consumer channel type changed during implementation (crossbeam -> tokio mpsc) but architecture doc was not updated. Risk of future stories being written against stale specs.
4. **Missing tests during development** — Lucas had to request test coverage during PR reviews, meaning the code review workflow didn't catch missing tests.
5. **No automated epic execution workflow** — Manual step-chaining (create-story, dev-story, code-review, open PR) led to skipped bookkeeping steps because agents optimized for throughput over process.
6. **Code duplication** — `fila_error_to_status()` duplicated between `admin_service.rs` and `service.rs`

## Key Insights

1. **Stories should be vertical slices** — Each story should deliver an observable behavior change, not a horizontal infrastructure layer. ACs should describe user-visible outcomes.
2. **Agent instructions must be explicit** — Agents optimize for what they're told and skip what they're not. Process steps (update story files, write tests for all ACs) must be explicit instructions, not implied expectations.
3. **A single epic execution workflow solves velocity and compliance** — Baking bookkeeping into automation means it can't be skipped.
4. **Test coverage must be verified in code review** — Not caught during human PR review as an afterthought.

## Previous Retrospective Follow-Through

N/A — This is the first retrospective (Epic 1).

## Next Epic Preview

**Epic 2: Fair Scheduling & Message Reliability** — 4 stories

Dependencies on Epic 1:
- DRR scheduler (2.1) builds on scheduler loop from Story 1.4
- DRR replaces `try_deliver_pending` full scan from Story 1.7
- Nack (2.3) builds on ack pattern from Story 1.8
- Visibility timeout (2.4) builds on lease expiry infrastructure from Stories 1.7/1.9

No significant discoveries requiring Epic 2 plan changes. The epic plan is sound.

## Action Items

### Process Improvements

| # | Action | Owner | When | Success Criteria |
|---|--------|-------|------|-----------------|
| 1 | Vertical story slicing for Epic 2 | Bob (SM) | During Epic 2 story creation | Every story delivers observable behavior change. No infrastructure-only stories. |
| 2 | Enforce test coverage in code review | Bob (SM) | Bake into code review workflow | Code review verifies every AC has a corresponding test. |
| 3 | Story file completion as workflow step | Embedded in epic workflow | Automatic | Story status, Dev Agent Record, task checkboxes, sprint-status all updated after each story. |

### Technical Debt

| # | Item | Owner | Priority | Notes |
|---|------|-------|----------|-------|
| 1 | Extract shared `fila_error_to_status()` | Charlie (Dev) | Low | Address when touching server code in Epic 2 |

### Documentation

| # | Item | Owner | Deadline |
|---|------|-------|----------|
| 1 | Update architecture doc to match codebase | Charlie (Dev) | Before Epic 2 story creation |
| 2 | Add basic README | Charlie (Dev) | Before Epic 2 |

### Knowledge Development

| # | Item | Owner | Deadline |
|---|------|-------|----------|
| 1 | Proptest spike | Dana (QA) | Before Story 2.2 |

## Critical Path — Before Epic 2

| # | Item | Owner | Blocks |
|---|------|-------|--------|
| 1 | **Build epic execution workflow/skill** | Lucas + Bob (SM) | All of Epic 2 |
| 2 | Update architecture doc | Charlie (Dev) | Epic 2 story creation |
| 3 | Add basic README | Charlie (Dev) | — |

### Epic Execution Workflow Requirements

Single command (`/bmad-custom-execute-entire-epic` or similar) that orchestrates:

1. Analyze story dependencies — identify parallel vs sequential execution
2. For each story:
   - Create branch (branch-on-branch for sequential deps, parallel branches for independent stories)
   - `/bmad-bmm-create-story`
   - `/bmad-bmm-dev-story`
   - `/bmad-bmm-code-review` — iterate until clean, verify tests cover all ACs
   - Update story file: status -> done, Dev Agent Record, task checkboxes
   - Update sprint-status.yaml
   - Open PR
   - Wait for CI to pass
   - Address Cubic review feedback
   - Move to next story
3. Leave all PRs open for Lucas to review
4. Complete when all stories have open, green PRs

## Post-Epic 2

- Implement e2e test suite (start real `fila-server` binary, exercise full flow via gRPC)

## Readiness Assessment

| Area | Status |
|------|--------|
| Testing & Quality | 59 tests passing. No manual e2e testing done (deferred to post-Epic 2). |
| Codebase Health | Stable. Lucas reports it feels fine. |
| Architecture Doc | Stale — needs update before Epic 2 (action item). |
| Unresolved Blockers | None. |

**Overall:** Epic 1 complete from a story perspective. 2 critical prep items (workflow + architecture doc update) before Epic 2 can begin.
